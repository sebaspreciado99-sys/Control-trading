<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- TÃ­tulo de la app -->
  <title>ğŸ“ˆ TRADING ğŸ“‰</title>
  
  <!-- ==================== META TAGS PWA ==================== -->
  <!-- Manifiesto PWA -->
  <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
  
  <!-- Color de tema -->
  <meta name="theme-color" content="#0a0c10">
  
  <!-- DescripciÃ³n -->
  <meta name="description" content="Sistema profesional de control y seguimiento de operaciones de trading">
  
  <!-- Para iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TRADING">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <!-- Para Microsoft -->
  <meta name="msapplication-TileColor" content="#0a0c10">
  <meta name="msapplication-TileImage" content="icon-144.png">
  <meta name="msapplication-config" content="browserconfig.xml">
  
  <!-- Para navegadores modernos -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="shortcut icon" href="icon-192.png">
  
  <!-- CSS personalizado -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- ==================== ESTILOS PWA ADICIONALES ==================== -->
  <style>
    /* Estilos especÃ­ficos para PWA instalada */
    .pwa-mode header {
      padding-top: env(safe-area-inset-top);
    }
    
    .pwa-mode #sesionActual {
      margin-top: env(safe-area-inset-top);
    }
    
    /* BotÃ³n de instalaciÃ³n PWA */
    #installButton {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: linear-gradient(135deg, #f0b90b, #f59e0b);
      color: #0a0c10;
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(240, 185, 11, 0.3);
      cursor: pointer;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    #installButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 185, 11, 0.4);
    }
    
    #installButton.show {
      display: flex;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Indicador de app instalada */
    .pwa-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #10b981;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      display: none;
    }
    
    .pwa-mode .pwa-badge {
      display: block;
    }
    
    /* Ajustes para modo standalone */
    @media all and (display-mode: standalone) {
      body {
        -webkit-tap-highlight-color: transparent;
      }
      
      .card-glass {
        border-radius: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- ==================== HEADER ==================== -->
  <header>
    <div class="header-glow">
      <h1>ğŸ“ˆ TRADING ğŸ“‰</h1>
      <div class="pwa-badge">APP</div>
    </div>
  </header>

  <!-- ==================== SECCIÃ“N HOME ==================== -->
  <section id="home">
    <div class="card-glass premium">
      <div class="input-group">
        <p class="label-input glow">ğŸ¯ Activo Financiero</p>
        <input id="inputPar" list="misPares" placeholder="Ej: BTCUSDT, EURUSD...">
        <datalist id="misPares"></datalist>
      </div>
      
      <div class="input-group">
        <p class="label-input glow">ğŸ¨ Etiqueta de Color</p>
        <div id="coloresRapidos"></div>
        <input type="color" id="colorPar" value="#f0b90b" class="color-picker">
      </div>
      
      <button onclick="guardarPar()" class="btn-main premium">
        <span>â•</span> Iniciar Registro
      </button>
    </div>

    <div id="listaPares"></div>
  </section>

  <!-- ==================== FORMULARIO DE OPERACIÃ“N ==================== -->
  <section id="operaciones" class="oculto">
    <h2 id="tituloPar" class="titulo-premium"></h2>
    
    <div class="card-glass premium">
        <!-- CAMPO ID CON VALIDACIÃ“N Y BOTÃ“N DE SUGERIR -->
        <div class="input-group">
          <p class="label-input glow">ğŸ”¢ #ID (Google Sheets)</p>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="number" id="idManualForm" placeholder="Deja vacÃ­o para auto-generar" min="1" 
                   style="font-weight: bold; color: #3b82f6; background: rgba(59, 130, 246, 0.1); flex: 1;">
            <button onclick="document.getElementById('idManualForm').value = sugerirIdDisponible()" 
                    style="background: #3b82f6; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 0.9rem;">
              Sugerir ID
            </button>
          </div>
          <small style="color: var(--subtext); font-size: 0.8rem; display: block; margin-top: 5px;">
            â€¢ Deja vacÃ­o para auto-generar ID consecutivo<br>
            â€¢ Usa el mismo ID de Google Sheets para actualizar un trade existente<br>
            â€¢ <span style="color: #ef4444;">âŒ Rojo</span>: ID ya existe | <span style="color: #10b981;">âœ… Verde</span>: ID disponible
          </small>
        </div>
        
        <div id="coloresRapidosEditar" class="color-grid"></div>
        <input type="color" id="colorAuto" class="color-picker">
        
        <div class="grid-2">
            <div class="input-group">
              <p class="label-input glow">ğŸ“… Fecha</p>
              <input type="date" id="fecha">
            </div>
            <div class="input-group">
              <p class="label-input glow">â° Hora</p>
              <input type="time" id="hora">
            </div>
        </div>

        <div class="grid-2">
            <div class="input-group">
              <p class="label-input glow">ğŸ“ˆ Tipo</p>
              <select id="tipo">
                <option>BUY</option>
                <option>SELL</option>
              </select>
            </div>
            <div class="input-group">
              <p class="label-input glow">ğŸ”¥ Gatillo</p>
              <select id="gatillo">
                <option>G3V</option>
                <option>ENVOLVENTE</option>
                <option>PINBAR</option>
              </select>
            </div>
        </div>

        <div class="grid-2">
            <div class="input-group">
              <p class="label-input glow">ğŸ›‘ SL Pips</p>
              <input type="number" placeholder="SL Pips" id="sl" step="0.01" min="0">
            </div>
            <div class="input-group">
              <p class="label-input glow">ğŸ¯ TP Pips</p>
              <input type="number" placeholder="TP Pips" id="tp" step="0.01" min="0">
            </div>
        </div>

        <div class="grid-2">
            <div class="input-group">
              <p class="label-input glow">RATIO</p>
              <input placeholder="RATIO" id="ratio" readonly class="input-readonly premium">
            </div>
            <div class="input-group">
              <p class="label-input glow">MAX RATIO</p>
              <input placeholder="MAX RATIO" id="maxRatio" step="0.01">
            </div>
        </div>
        
        <div class="input-group">
          <p class="label-input glow">ğŸ† RESULTADO</p>
          <input placeholder="WIN / LOSS / BE" id="resultado">
        </div>

        <div class="input-group">
          <p class="label-input glow">â±ï¸ DURACIÃ“N</p>
          <input placeholder="Ej: 1D 2H" id="duracion">
        </div>

        <div class="input-group">
          <p class="label-input glow">ğŸ”— LINK DIARIO</p>
          <input type="url" placeholder="URL de captura diaria" id="diario">
        </div>

        <div class="input-group">
          <p class="label-input glow">ğŸ”— LINK HORARIO</p>
          <input type="url" placeholder="URL de captura H1, M15..." id="horario">
        </div>

        <div class="input-group">
          <p class="label-input glow">ğŸ“Š PORCENTAJE %</p>
          <input placeholder="Ej: 0.5, 1, 2..." id="porcentaje">
        </div>
        
        <div class="grid-2 r-grid">
            <div class="input-group">
              <p class="label-input glow">ğŸ“‰ R NEG</p>
              <input placeholder="R NEG" id="rNegativo" class="input-danger">
            </div>
            <div class="input-group">
              <p class="label-input glow">ğŸ“ˆ R POS</p>
              <input placeholder="R POS" id="rPositivo" class="input-success">
            </div>
        </div>
        
        <button onclick="archivarPar()" class="btn-archive premium">ğŸ“¥ Archivar Trade</button>
        <button onclick="volverHome()" class="btn-secondary premium">â¬… Volver</button>
    </div>
  </section>

  <!-- ==================== HISTORIAL ==================== -->
  <section id="historial" class="oculto">
    <h2 class="titulo-premium">ğŸ“ HISTORIAL</h2>
    
    <div class="card-glass premium filter-panel">
        <input 
          type="text" 
          id="filtroNombre" 
          placeholder="ğŸ” Buscar por nombre..." 
          oninput="abrirHistorial()" 
          class="input-search">
        <input type="date" id="filtroFecha" onchange="abrirHistorial()">
        <button onclick="limpiarFiltros()" class="btn-ghost">âœ¨ Limpiar</button>
    </div>

    <div id="resumenGlobal" class="resumen-premium"></div>
    <button onclick="eliminarSeleccionados()" class="btn-danger premium">ğŸ—‘ Borrar Seleccionados</button>
    <div id="historialContenido"></div>
    <button onclick="volverHome()" class="btn-secondary premium">â¬… Volver</button>
  </section>

  <!-- ==================== DETALLE ==================== -->
  <section id="detalle" class="oculto">
    <h2 id="detalleTitulo" class="titulo-premium"></h2>
    <div id="detalleContenido"></div>
    <button onclick="volverHistorial()" class="btn-secondary premium">â¬… Volver</button>
  </section>

  <!-- ==================== ELEMENTOS ADICIONALES ==================== -->
  <!-- SesiÃ³n actual -->
  <div id="sesionActual"></div>

  <!-- BotÃ³n flotante historial -->
  <button id="btnHistorial" onclick="abrirHistorial()" class="fab-premium">ğŸ“</button>

  <!-- BotÃ³n de instalaciÃ³n PWA -->
  <button id="installButton" class="oculto">
    <span>ğŸ“±</span> Instalar App
  </button>

  <!-- ==================== SCRIPTS ==================== -->
  <script src="app.js"></script>
  
  <script>
    // ==================== PWA INSTALLATION HANDLER ====================
    let deferredPrompt;
    const installButton = document.getElementById('installButton');
    
    // Detectar si ya estÃ¡ instalada como PWA
    function detectPWA() {
      // Modo standalone (iOS/Android)
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
      
      // Navegadores especÃ­ficos
      const isInWebAppiOS = (window.navigator.standalone === true);
      const isInWebAppChrome = (window.matchMedia('(display-mode: standalone)').matches);
      
      if (isStandalone || isInWebAppiOS || isInWebAppChrome) {
        console.log('ğŸ“± App ejecutÃ¡ndose como PWA instalada');
        document.body.classList.add('pwa-mode');
        installButton.classList.remove('show');
        return true;
      }
      return false;
    }
    
    // Escuchar evento beforeinstallprompt
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('ğŸ“± beforeinstallprompt activado');
      // Prevenir que Chrome muestre su prompt automÃ¡tico
      e.preventDefault();
      // Guardar el evento para usarlo despuÃ©s
      deferredPrompt = e;
      
      // Solo mostrar nuestro botÃ³n si NO es PWA ya
      if (!detectPWA()) {
        installButton.classList.add('show');
      }
    });
    
    // Manejar clic en botÃ³n de instalaciÃ³n
    installButton.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      // Mostrar el prompt de instalaciÃ³n
      deferredPrompt.prompt();
      
      // Esperar a que el usuario responda
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`ğŸ“± Usuario ${outcome} la instalaciÃ³n`);
      
      // Ya no necesitamos el prompt
      deferredPrompt = null;
      
      // Ocultar nuestro botÃ³n
      installButton.classList.remove('show');
      
      if (outcome === 'accepted') {
        console.log('âœ… PWA instalada con Ã©xito');
        mostrarToast('âœ… App instalada correctamente', 'exito');
        document.body.classList.add('pwa-mode');
      }
    });
    
    // Detectar cuando la app se instala
    window.addEventListener('appinstalled', (evt) => {
      console.log('ğŸ‰ PWA instalada exitosamente');
      installButton.classList.remove('show');
      document.body.classList.add('pwa-mode');
    });
    
    // ==================== SERVICE WORKER REGISTRATION ====================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('âœ… Service Worker registrado:', registration.scope);
            
            // Verificar actualizaciones cada 24 horas
            setInterval(() => {
              registration.update();
            }, 24 * 60 * 60 * 1000);
            
            // Escuchar nuevas versiones
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('ğŸ”„ Nueva versiÃ³n disponible');
                  mostrarToast('ğŸ”„ Nueva versiÃ³n disponible. Recarga la app.', 'exito');
                }
              });
            });
          })
          .catch(error => {
            console.error('âŒ Error al registrar Service Worker:', error);
          });
      });
    }
    
    // ==================== OFFLINE DETECTION ====================
    window.addEventListener('online', () => {
      console.log('ğŸŒ Conectado a internet');
      mostrarToast('âœ… Conectado a internet', 'exito');
    });
    
    window.addEventListener('offline', () => {
      console.log('ğŸ“´ Sin conexiÃ³n a internet');
      mostrarToast('âš ï¸ Modo offline activado', 'error');
    });
    
    // Detectar estado inicial
    if (!navigator.onLine) {
      console.log('ğŸ“´ Iniciando en modo offline');
      mostrarToast('âš ï¸ Trabajando en modo offline', 'error');
    }
    
    // ==================== INICIALIZAR DETECCIÃ“N PWA ====================
    // Esperar un momento para que todo cargue
    setTimeout(() => {
      detectPWA();
      
      // Si no estÃ¡ instalada y no hay prompt despuÃ©s de 5 seg, mostrar ayuda
      setTimeout(() => {
        if (!document.body.classList.contains('pwa-mode') && !installButton.classList.contains('show')) {
          console.log('ğŸ’¡ Para instalar la app: MenÃº â†’ "Agregar a pantalla de inicio"');
        }
      }, 5000);
    }, 1000);
    
    // ==================== FULLSCREEN SUPPORT ====================
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`âŒ Error al activar pantalla completa: ${err.message}`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }
    
    // AÃ±adir listener para tecla F11
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F11') {
        e.preventDefault();
        toggleFullscreen();
      }
    });
  </script>
</body>
</html>
